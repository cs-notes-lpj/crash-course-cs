表示数字的确是计算机的一个重要功能，

但创造计算机的真正目的是计算，即 => 有意义地处理数字

处理数字这个活儿交给计算机的「算术逻辑单元 arithmetic & logic unit」进行

这玩意儿简称 ALU，包含 1 个算术单元和 1 个逻辑单元，是计算机的数学大脑

一旦你理解了 ALU 的设计和功能，你就理解了现代计算机的基石 :)

---

世界上首个被封装在单个芯片内的完整 ALU 是 Intel 的 74181，发布于 1970

这在当时是惊人的工程壮举

![20221205093038](https://aliyun-oss-lpj.oss-cn-qingdao.aliyuncs.com/images/by-clipboard/20221205093038.png)

在接下来的内容中，我们将仿照 74181，用之前学过的逻辑门，设计一个简单的 ALU 电路，进而设计一个 CPU，造一台计算机 ！

### Arithmetic unit

算术单元负责计算机里的所有数字操作，比如加减法

不妨先来考虑做出具备加法功能的电路，就比如两数相加

如果你使用单个的晶体管一个一个地拼，确实也能将这个电路拼出来，但很快就会复杂到难以理解

所以，我们不如用更高层的抽象，即：用逻辑门来设计出这个电路

```txt
AND、OR、XOR、NOT
```

---

最简单的加法电路是实现：将两个 bit 加在一起

- 这个电路会有 2 个输入：A & B

- 输出分为两种情况：无进位 & 有进位

不妨先考虑输出无进位的情况，输入会有下图这 3 种情况

![20221205103756](https://aliyun-oss-lpj.oss-cn-qingdao.aliyuncs.com/images/by-clipboard/20221205103756.png)

这和 XOR 门的逻辑完全相同 ！

![20221205104133](https://aliyun-oss-lpj.oss-cn-qingdao.aliyuncs.com/images/by-clipboard/20221205104133.png)

所以，we can use it as our 1-bit adder ！

对于有进位的情况，输入只有下图这 1 种

![20221205104440](https://aliyun-oss-lpj.oss-cn-qingdao.aliyuncs.com/images/by-clipboard/20221205104440.png)

而在这种输入方式下，XOR 门的输出只对了一部分（输出的确是 0，但没体现出进位）

显然我们需要一根额外的输出线，来体现进位，就像下图这样的逻辑

![20221205105049](https://aliyun-oss-lpj.oss-cn-qingdao.aliyuncs.com/images/by-clipboard/20221205105049.png)

我们刚好有个逻辑门能做这件事情 ！the AND gate ！

![20221205105322](https://aliyun-oss-lpj.oss-cn-qingdao.aliyuncs.com/images/by-clipboard/20221205105322.png)

这个电路，被称为「半加器 half adder」

不妨做一下抽象，将半加器封装成一个单独的组件

![20221205105608](https://aliyun-oss-lpj.oss-cn-qingdao.aliyuncs.com/images/by-clipboard/20221205105608.png)

ok，但如果想要处理超过 1+1 的运算，比如下图

![20221205110159](https://aliyun-oss-lpj.oss-cn-qingdao.aliyuncs.com/images/by-clipboard/20221205110159.png)

那么就需要「全加器 Full Adder」

既然半加器输出了进位，那么这就意味着我们计算下一列的时候，还有之后的每一列，我们都需要将 3 个 bit 加在一起，有以下 8 种情况

![20221205111657](https://aliyun-oss-lpj.oss-cn-qingdao.aliyuncs.com/images/by-clipboard/20221205111657.png)

我们可以用半加器来做全加器

![20221205112129](https://aliyun-oss-lpj.oss-cn-qingdao.aliyuncs.com/images/by-clipboard/20221205112129.png)

使用 1 个 OR 门来检查是否有进位

![20221205112543](https://aliyun-oss-lpj.oss-cn-qingdao.aliyuncs.com/images/by-clipboard/20221205112543.png)

That's it, we just made a full adder !

不妨再提升一层抽象，将全加器封装为独立组件

![20221205113035](https://aliyun-oss-lpj.oss-cn-qingdao.aliyuncs.com/images/by-clipboard/20221205113035.png)

即：全加器会将 A、B、C 三个输入加起来，输出「总和 & 进位」

ok，既然我们有了新组件，那么接下来我们就可以让两个 8 位数字相加

即：制作「8 位加法器 8-BIT ADDER」

![20221205121327](https://aliyun-oss-lpj.oss-cn-qingdao.aliyuncs.com/images/by-clipboard/20221205121327.png)

如果第 8 位有进位，进到了第 9 位，那么这就说明这俩数字的和太大了，超过了 8 位

这被称为「溢出 overflow」

![20221205121756](https://aliyun-oss-lpj.oss-cn-qingdao.aliyuncs.com/images/by-clipboard/20221205121756.png)

一个有名的例子是：游戏《吃豆人》用 8 bits 来表示当前关卡数，但如果你玩到了第 256 关（8 bits 最大 255），ALU 就会溢出，进而造成一连串错误和乱码，使得该关卡无法进行

![20221205122155](https://aliyun-oss-lpj.oss-cn-qingdao.aliyuncs.com/images/by-clipboard/20221205122155.png)

有趣的是：这个 BUG 成了厉害吃豆人玩家的代表 :)

so, 如果想降低溢出发生的概率，那么就需要使用更多的全加器，也就是使用更多的逻辑门，以支持我们操作 16 位或 32 位的数字

还有一个缺点：每次进位都需要一点时间（尽管时间并不久，毕竟电子的移动速度很快），在如今每秒几十亿次运算的量级下，还是会有一定影响

so, 自己权衡时空开销。

so, 现代计算机用的加法电路是有一些不同的 ！called「CARRY-LOOK-AHEAD-ADDER」

这种加法电路实现的功能是一样的，但运行速度更快 ！

---

ALU 的算术单元也能做其他数学运算，同样也都是由逻辑门构成的

一般支持如下 8 种操作

![20221205153304](https://aliyun-oss-lpj.oss-cn-qingdao.aliyuncs.com/images/by-clipboard/20221205153304.png)

有趣的是：你可能注意到上图中没有乘除法

这是因为简单的 ALU 把乘法用多次加法来实现，很多简单处理器都是这么做的（比如电视遥控器、比如微波炉）

虽然这样实现的运算速度慢一点，但搞得定。

然而笔记本和手机都有更好的处理器，有专门为做乘法设计的电路算术单元

当然，这些乘法电路比加法电路更复杂，但也只是更多的逻辑门而已。

### Logic unit

接下来讲逻辑单元

逻辑单元负责执行逻辑操作，就比如之前讲过的 AND、OR、XOR、NOT

它也能做简单的数值测试，比如判断一个数字是不是负数

---

仍然以 8 bits 计算为例

下图是检查 ALU 输出是否为 0 的电路

![20221205154950](https://aliyun-oss-lpj.oss-cn-qingdao.aliyuncs.com/images/by-clipboard/20221205154950.png)

不难理解：只有当输入的数字全为 0，输出才为 1

### 总结

现在我们已经对 ALU 有了一个大致了解，我们甚至从晶体管开始，设计出了几个主要组件，比如 ripple adder

它们只不过是一大堆逻辑门巧妙地连接在一起而已

---

其实，the Intel 74181 这个著名的 ALU 用了大概 70 个逻辑门，它只能处理 4 位输入，且无法进行乘除法

![20221205160359](https://aliyun-oss-lpj.oss-cn-qingdao.aliyuncs.com/images/by-clipboard/20221205160359.png)

但 74181 向计算机小型化的方向迈出了一大步 ！让计算机更强大、更便宜 ！

---

4 位 ALU 已经需要很多逻辑门了，我们的 8 位 ALU 会需要几百个逻辑门，工程师们并不想在使用 ALU 时考虑这些复杂的东西，所以用了一个特殊符号来表示它，就是一个看起来像大 V 的符号

![20221205160955](https://aliyun-oss-lpj.oss-cn-qingdao.aliyuncs.com/images/by-clipboard/20221205160955.png)

这是又一层抽象奥 ！

---

我们的 8 位 ALU 有两个输入，A 和 B，都是 8 bits

我们还需要告诉 ALU 执行什么操作，所以我们用 4 位的操作代码（后续会细讲）

ALU 还会输出一堆 1 bit 的 flags，表示特定状态

- 比如相减两个数字，结果为 0，那么我们之前做的零测试电路就会将零标志设置为 true(1)，比如如果想知道两个数字是否相等，这个就派上用场了

- 当然，还有一条线连接到加法器的进位，如果有溢出，我们就能通过这个溢出标志看到

![20221205162741](https://aliyun-oss-lpj.oss-cn-qingdao.aliyuncs.com/images/by-clipboard/20221205162741.png)

更高级的 ALU 往往有更多的标志，但上图中的 3 个标志是 ALU 中普遍用到的，并且我们之后还会用到它们

---

我们之后会用 ALU 造 CPU，但在此之前，计算机还需要一些「记忆」

请看下回分解...

